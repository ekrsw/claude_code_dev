# 要件定義書 - Python API設計（既存ナレッジ修正案管理システム）

## 1. 目的

既存記事（ナレッジ）に対する修正案の提出、承認、管理を行うPython APIシステムを設計・構築し、修正提案のワークフロー機能を提供する。

## 2. 機能要件

### 2.1 必須機能

#### ユーザー管理
- [ ] ユーザー登録（サインアップ）
- [ ] ユーザー認証（ログイン/ログアウト）
- [ ] ユーザー情報取得
- [ ] ユーザー情報更新
- [ ] ユーザー削除
- [ ] ユーザープロファイルの拡張管理
  - Sweetシフト表連携用名前(sweet_name)
  - Ctstageレポータ連携用名前(ctstage_name)
  - スーパーバイザー権限設定(is_sv)

#### 既存記事参照・修正案管理
- [ ] 既存記事一覧取得（ページネーション対応）
- [ ] 既存記事詳細取得
- [ ] 記事検索機能
- [ ] 修正案作成・提出
- [ ] 修正案一覧取得（ステータス別）
- [ ] 修正案詳細取得（差分表示）
- [ ] 修正案承認・却下機能
- [ ] 修正案のコメント・フィードバック管理
- [ ] 修正履歴追跡機能
- [ ] 情報カテゴリ分類管理
- [ ] キーワード管理機能
- [ ] 重要度設定（一般/重要）
- [ ] 対象者分類（社内/社外/対象外）
- [ ] Q&A機能（質問・回答ペア）

#### 認証・認可
- [ ] JWT認証システム
- [ ] 修正案の提出者のみが編集・削除可能
- [ ] 修正案承認権限の管理（承認者ロール）
- [ ] 管理者権限の実装
- [ ] スーパーバイザー(SV)権限の実装
  - 一般ユーザーより上位、管理者より下位の権限レベル
  - 修正案の承認や記事管理の一部機能にアクセス可能

#### 外部システム連携
- [ ] Sweetシフト管理システムとの連携
  - ユーザー名のマッピング（sweet_name）
  - シフト情報の参照機能（将来的）
- [ ] Ctstageレポーティングシステムとの連携
  - ユーザー名のマッピング（ctstage_name）
  - レポートデータの参照機能（将来的）

### 2.2 オプション機能

- [ ] 修正案への詳細コメント・レビュー機能
- [ ] 記事のタグ付け・カテゴリ分類の修正提案
- [ ] ユーザーフォロー機能
- [ ] 修正案のブックマーク機能
- [ ] 添付ファイル（画像等）の修正提案
- [ ] API使用量制限（レート制限）
- [ ] 修正案の一括承認・却下機能
- [ ] 外部システムとのAPI連携拡張
  - Sweet APIとのリアルタイムシフト情報取得
  - Ctstage APIとのレポートデータ連携
- [ ] ユーザーロール管理機能の強化
  - SV権限での修正案承認ログ管理
  - ロールベースアクセス制御(RBAC)の実装

## 3. 非機能要件

### 3.1 パフォーマンス

- API応答時間: 95%のリクエストで500ms以下
- 同時接続数: 100ユーザー以上
- データベースクエリ最適化

### 3.2 セキュリティ

- パスワードのハッシュ化（bcrypt使用）
- JWT トークンによる認証
- SQLインジェクション対策
- CORS設定
- 入力値バリデーション
- HTTPS対応
- スーパーバイザー権限の管理とアクセス制御
- 外部システム連携時のデータ保護と機密情報の取り扱い

### 3.3 保守性

- コードの可読性とドキュメント化
- ユニットテストカバレッジ80%以上
- OpenAPI/Swagger仕様書の自動生成
- ログ機能の実装

### 3.4 互換性

- Python 3.12以上3.13未満対応
- RESTful API設計原則に準拠
- JSON形式でのデータ交換
- FastAPI 0.115.12との互換性確保
- SQLAlchemy 2.0.40非同期対応
- 修正案管理システムの一意性とデータ整合性保証

## 4. 制約事項

### 4.1 技術的制約

- 言語: Python 3.12+（3.13未満）
- フレームワーク: FastAPI 0.115.12
- データベース: PostgreSQL（asyncpg 0.30.0）
- ORM: SQLAlchemy 2.0.40（非同期対応）
- 認証: python-jose 3.4.0（JWT）
- キャッシュ: Redis 5.3.0 / aioredis 2.0.1
- パスワード暗号化: passlib 1.7.4 / bcrypt 4.0.1
- バリデーション: pydantic 2.11.3
- マイグレーション: alembic 1.15.2
- モノリシック設計（Docker・RabbitMQ使用なし）

### 4.2 ビジネス制約

- 開発期間: 相談により決定
- 初期段階では単一サーバー構成
- 日本語対応必須
- Sweet、Ctstageシステムとの統合は段階的実装
- 既存ユーザーデータへの影響を最小限にする

## 5. 成功基準

### 5.1 完了の定義

- [ ] 全ての必須機能が実装され、正常に動作する
- [ ] API仕様書が完備されている
- [ ] 基本的なテストケースが実装され、すべてパスする
- [ ] セキュリティ要件が満たされている
- [ ] デプロイ可能な状態になっている
- [ ] ユーザープロファイルの拡張フィールドが適切に管理される
- [ ] スーパーバイザー権限が正しく機能する
- [ ] 外部システム連携のためのフィールドが適切に設定される

### 5.2 受け入れテスト

- ユーザー登録からログイン、修正案提出から承認までの一連の流れが正常に動作する
- 権限管理が適切に機能する（一般ユーザー、SV、管理者、承認者）
- 修正案の差分表示とコメント機能が正常に動作する
- APIドキュメントが分かりやすく整備されている
- ユーザープロファイルの拡張フィールドが正しく更新できる
- Sweet、Ctstageシステムとの連携用フィールドが正しく管理される

## 6. 想定されるリスク

- データベース設計の変更による影響範囲の拡大
- 認証システムの脆弱性
- パフォーマンス要件を満たせない可能性
- 外部ライブラリの脆弱性や非互換性
- 外部システム（Sweet、Ctstage）との連携リスク
  - 外部APIの仕様変更やサービス停止
  - データ同期の問題や整合性の確保
- ユーザーロール管理の複雑化
  - SV権限の範囲や制約の曖昧さ
  - 権限エスカレーションのセキュリティリスク

## 7. 今後の検討事項

### データベース設計
- ユーザーテーブルの詳細な項目定義（sweet_name、ctstage_name、is_sv含む）
- 既存記事テーブルの詳細な項目定義（参照専用）
  - 記事ID（article_id: String）
  - 記事番号（article_number: String）
  - 承認グループ（approval_group: String）
- 修正案テーブルの設計
  - 修正案ID（revision_id: UUID）
  - 対象記事ID（target_article_id: UUID）
  - 提案者ID（proposer_id: UUID）
  - 修正内容（詳細な修正前後データ）
    - 修正前タイトル（before_title: Text, nullable）
    - 修正後タイトル（after_title: Text, nullable）
    - 修正前情報カテゴリ（before_info_category: String, nullable）
    - 修正後情報カテゴリ（after_info_category: String, nullable）
    - 修正前キーワード（before_keywords: Text, nullable）
    - 修正後キーワード（after_keywords: Text, nullable）
    - 修正前重要度（before_importance: Boolean, nullable）
    - 修正後重要度（after_importance: Boolean, nullable）
    - 修正前公開期限（開始）（before_publish_start: Timestamp, nullable）
    - 修正後公開期限（開始）（after_publish_start: Timestamp, nullable）
    - 修正前公開期限（終了）（before_publish_end: Timestamp, nullable）
    - 修正後公開期限（終了）（after_publish_end: Timestamp, nullable）
    - 修正前対象（before_target: String, nullable）
    - 修正後対象（after_target: String, nullable）
    - 修正前質問（before_question: Text, nullable）
    - 修正後質問（after_question: Text, nullable）
    - 修正前回答（before_answer: Text, nullable）
    - 修正後回答（after_answer: Text, nullable）
    - 修正前追加コメント（before_additional_comment: Text, nullable）
    - 修正後追加コメント（after_additional_comment: Text, nullable）
  - 修正理由（reason: Text）
  - ステータス（status: pending/approved/rejected）
  - 承認者ID（approver_id: UUID, nullable）
  - 承認・却下日時（processed_at: Timestamp, nullable）
  - コメント・フィードバック（comments: Text）
- テーブル間のリレーション設計
- インデックス設計（is_svフラグ、修正案ステータス、対象記事IDのパフォーマンス考慮）
- 既存データへの影響を最小化する設計戦略

### 修正案管理システム
- 修正案の提出・管理機能
  - 既存記事に対する修正提案の作成
  - 修正箇所の明確化（差分表示機能）
  - 修正理由の記録と管理
  - 提案者による修正案の編集・取り下げ機能
- 承認ワークフロー管理
  - 修正案のステータス管理（pending/approved/rejected）
  - 承認者権限の管理とアクセス制御
  - 承認・却下時のコメント機能
  - 承認履歴の追跡と監査ログ
- 差分表示・比較機能
  - 修正前後の内容比較表示
  - 視覚的な差分ハイライト機能
  - 部分修正と全体修正の対応
- エラーハンドリングと整合性チェック
  - 同一記事への複数修正案の競合解決
  - データ整合性チェック機能
  - 修正案提出失敗時のリトライ機構

### 修正案レビュー期間管理システム
- 修正案レビュー期間設定機能
  - レビュー開始日（review_start_date）: 提出時に自動設定
  - レビュー期限日（review_deadline_date）: 設定可能
  - 緊急修正案の優先処理機能
  - レビュー期限の延長申請機能
- 修正案のアクセス制御
  - 提案中: 提案者・承認者・管理者・SV権限者のみ閲覧可能
  - 承認後: 対象者設定に応じて一般ユーザーも閲覧可能
  - 却下後: 提案者・承認者・管理者・SV権限者のみ閲覧可能
- バッチ処理による期限管理
  - 日次バッチでレビュー期限をチェック
  - 期限超過時の通知機能
  - 長期未処理案件のエスカレーション機能
- レビュー期間の管理機能
  - 管理者・SV権限者による期限変更
  - 変更履歴の記録と承認者への通知

### 記事カテゴリ管理システム
- 情報カテゴリマスター管理
  - カテゴリ名（日本語表示用）
  - カテゴリコード（2文字、識別用）
  - 表示順序設定
  - 有効/無効フラグ
- カテゴリ選択インターフェース
  - ドロップダウン形式での選択UI
  - カテゴリ階層構造（親子関係）対応
  - 新規カテゴリ追加時の影響範囲確認
- カテゴリ別修正案管理機能
  - カテゴリ別修正案一覧表示
  - カテゴリ別検索・フィルタリング
  - カテゴリ変更提案の管理
- 管理者向けカテゴリメンテナンス
  - 新規カテゴリの追加・編集・削除
  - カテゴリ統合・分割機能
  - 使用統計レポート（カテゴリ別記事数、修正案数など）

### API設計
- 修正案管理エンドポイントの設計
  - 既存記事参照API
  - 修正案CRUD操作API
  - 差分表示・比較API
  - 承認・却下処理API
- リクエスト/レスポンス形式の詳細
- エラーハンドリングの統一ルール
- バージョニング戦略
- SV権限・承認者権限専用エンドポイントの設計

### アーキテクチャ設計
- ディレクトリ構造
- レイヤード アーキテクチャの採用
- 設定管理方法

### 外部システム連携
- Sweet APIとの連携仕様詳細
  - シフトデータ取得方法
  - 認証方式とセキュリティ
- Ctstage APIとの連携仕様詳細
  - レポートデータ取得方法
  - データフォーマットと変換処理

### 権限管理設計
- SV権限の具体的なスコープ定義（修正案承認権限含む）
- 承認者ロールの権限範囲と制約
- ロールベースアクセス制御(RBAC)の設計
- 権限継承と委譲のメカニズム
- 修正案の承認ワークフロー権限設計